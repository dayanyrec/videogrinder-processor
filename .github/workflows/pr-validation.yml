name: ðŸ” Pull Request Validation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  quick-validation:
    name: âš¡ Quick Validation
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: image=moby/buildkit:buildx-stable-1

    - name: ðŸ“ Create required directories
      run: mkdir -p uploads outputs temp tmp

    - name: ðŸ”§ Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: buildx-dev-${{ github.sha }}
        restore-keys: |
          buildx-dev-${{ github.base_ref }}
          buildx-dev-

    - name: ðŸ—ï¸ Build development image (cached)
      run: |
        docker buildx build \
          --target development \
          --cache-from type=local,src=/tmp/.buildx-cache \
          --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
          --load \
          --tag videogrinder-dev:pr-${{ github.event.pull_request.number }} \
          .

    - name: ðŸ”„ Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: ðŸŽ¨ Run code formatting check
      run: |
        docker run --rm \
          -v $(pwd):/app \
          -w /app \
          videogrinder-dev:pr-${{ github.event.pull_request.number }} \
          make fmt

    - name: ðŸ” Run linting
      run: |
        docker run --rm \
          -v $(pwd):/app \
          -w /app \
          videogrinder-dev:pr-${{ github.event.pull_request.number }} \
          make lint

    - name: ðŸ§ª Run unit tests
      run: |
        docker run --rm \
          -v $(pwd):/app \
          -w /app \
          videogrinder-dev:pr-${{ github.event.pull_request.number }} \
          make test

  build-validation:
    name: ðŸ—ï¸ Build Validation
    runs-on: ubuntu-latest
    needs: quick-validation

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ“ Create required directories
      run: mkdir -p uploads outputs temp tmp

    - name: ðŸ—ï¸ Build production image
      run: make setup prod

    - name: ðŸ§ª Verify production build
      run: |
        echo "âœ… Production image built successfully"
        docker images | grep videogrinder

  pr-summary:
    name: ðŸ“‹ PR Summary
    runs-on: ubuntu-latest
    needs: [quick-validation, build-validation]
    if: always()

    steps:
    - name: ðŸ“Š Validation Summary
      run: |
        echo "## ðŸ” Pull Request Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.quick-validation.result }}" = "success" ]; then
          echo "âœ… **Quick Validation**: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "  - Code formatting: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "  - Linting (Go + JS): âœ…" >> $GITHUB_STEP_SUMMARY
          echo "  - Unit tests: âœ…" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Quick Validation**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.build-validation.result }}" = "success" ]; then
          echo "âœ… **Build Validation**: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "  - Production build: âœ…" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Build Validation**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **Ready for merge**: ${{ needs.quick-validation.result == 'success' && needs.build-validation.result == 'success' }}" >> $GITHUB_STEP_SUMMARY
