name: ğŸ” VideoGrinder CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  quality-checks:
    name: ğŸ” Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”§ Install Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.37.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        docker-compose --version

    - name: ğŸ“ Create required directories
      run: |
        mkdir -p uploads outputs temp tmp

    - name: ğŸ¨ Run code formatting
      run: make fmt

    - name: ğŸ” Run linting (Go + JS)
      run: make lint

    - name: ğŸ§ª Run unit tests (Go)
      run: make test

    - name: ğŸ§ª Run unit tests (JS)
      run: make test-unit

  build-test:
    name: ğŸ—ï¸ Build & Production Test
    runs-on: ubuntu-latest
    needs: quality-checks

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”§ Install Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.37.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        docker-compose --version

    - name: ğŸ“ Create required directories
      run: |
        mkdir -p uploads outputs temp tmp

    - name: ğŸ—ï¸ Build production image
      run: make setup prod

    - name: ğŸ§ª Test production image startup
      run: |
        echo "ğŸš€ Testing production image startup..."
        timeout 30s make run prod || true
        docker-compose logs videogrinder-prod
        docker-compose down

  e2e-tests:
    name: ğŸ­ End-to-End Tests
    runs-on: ubuntu-latest
    needs: build-test

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”§ Install Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.37.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        docker-compose --version

    - name: ğŸ“ Create required directories
      run: |
        mkdir -p uploads outputs temp tmp

    - name: ğŸš€ Start application
      run: |
        make setup dev
        make run dev &

    - name: â³ Wait for application to be ready
      run: |
        echo "Waiting for application to start..."
        timeout 60s bash -c 'until curl -f http://localhost:8080/api/status; do sleep 2; done'
        echo "Application is ready!"

    - name: ğŸ­ Run E2E tests
      run: make test-e2e

    - name: ğŸ“¸ Upload Cypress screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-screenshots
        path: cypress/screenshots
        retention-days: 30

    - name: ğŸ¥ Upload Cypress videos
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-videos
        path: cypress/videos
        retention-days: 30

    - name: ğŸ“‹ Show logs on failure
      if: failure()
      run: |
        echo "=== Application Logs ==="
        make logs dev || docker-compose logs

    - name: ğŸ§¹ Cleanup
      if: always()
      run: make down
